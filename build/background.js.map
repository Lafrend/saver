{"version":3,"file":"background.js","mappings":";;;;;;;AAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,0BAA0B,mCAAmC;AAC7D;AACA;AACA;AACA;AACA,SAAS;AACT;AACA,OAAO;AACP,MAAM;AACN;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA,wBAAwB,mCAAmC;AAC3D;AACA,8CAA8C,4BAA4B;AAC1E,KAAK;AACL;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA,KAAK;AACL;AACA;AACA,+CAA+C,gBAAgB;AAC/D;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B,0BAA0B;AACzD;AACA,KAAK;AACL,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://saver/./src/background.js"],"sourcesContent":["\"use strict\";\r\n\r\nchrome.runtime.onInstalled.addListener(function () {\r\n  // Add a context menu item for selected text\r\n  chrome.contextMenus.create({\r\n    title: \"Сохранить\",\r\n    id: \"save\",\r\n    contexts: [\"selection\", \"image\", \"video\", \"link\"],\r\n  });\r\n});\r\nchrome.contextMenus.onClicked.addListener(function (info, tab) {\r\n  if (info.menuItemId == \"save\") {\r\n    const selected =\r\n      info.selectionText || info.srcUrl || info.linkUrl || info.videoUrl || \"\";\r\n    if (isImage(selected)) {\r\n      chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {\r\n        const activeTab = tabs[0];\r\n        chrome.tabs.sendMessage(activeTab.id, {\r\n          command: \"processImage\",\r\n          imageUrl: selected,\r\n        });\r\n        console.log(\"Send message to content with imgurl:\", selected);\r\n      });\r\n    } else {\r\n      saveItem(info);\r\n    }\r\n  }\r\n});\r\nchrome.commands.onCommand.addListener(function (command) {\r\n  if (command === \"saveItemCommand\") {\r\n    // Отправляем сообщение контент-скрипту с запросом выделенного текста\r\n    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {\r\n      const activeTab = tabs[0];\r\n      chrome.tabs.sendMessage(activeTab.id, { command: \"getSelectedText\" });\r\n    });\r\n  }\r\n});\r\nchrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {\r\n  if (request.command === \"saveItem\" && request.selectedText) {\r\n    // Создаем новый элемент с выделенным текстом\r\n    const newItem = {\r\n      selectionText: request.selectedText,\r\n      createdAt: \"\",\r\n    };\r\n    // Сохраняем новый элемент с использованием существующей функции\r\n    saveItem(newItem);\r\n  } else if (request.command === \"imageProcessed\" && request.formattedText) {\r\n    console.log(\"got formatted text\");\r\n    const newItem = {\r\n      createdAt: new Date().getTime(),\r\n      title: \"\",\r\n      itemData: request.formattedText,\r\n      pinned: false,\r\n      hide: false,\r\n      fav: false,\r\n      color: \"\",\r\n      tab: \"\",\r\n      list: \"\",\r\n    };\r\n\r\n    // Сохраняем новый элемент\r\n    saveNewItem(newItem);\r\n  }\r\n});\r\nfunction saveItem(info) {\r\n  const selected =\r\n    info.selectionText || info.srcUrl || info.linkUrl || info.videoUrl || \"\";\r\n\r\n  let itemData;\r\n  itemData = selected;\r\n\r\n  const newItem = {\r\n    createdAt: new Date().getTime(),\r\n    title: \"\",\r\n    itemData: itemData,\r\n    pinned: false,\r\n    hide: false,\r\n    fav: false,\r\n    color: \"\",\r\n    tab: \"\",\r\n    list: \"\",\r\n  };\r\n\r\n  saveNewItem(newItem);\r\n}\r\nfunction formatImageAsText(imageUrl) {\r\n  return new Promise((resolve, reject) => {\r\n    // Создаем изображение\r\n    const img = document.createElement(\"img\");\r\n    // Обработчик, вызываемый после загрузки изображения\r\n    img.onload = function () {\r\n      // Создаем элемент canvas для рисования изображения\r\n      const canvas = document.createElement(\"canvas\");\r\n      canvas.width = img.width;\r\n      canvas.height = img.height;\r\n      // Получаем контекст для рисования\r\n      const context = canvas.getContext(\"2d\");\r\n      // Рисуем изображение на canvas\r\n      context.drawImage(img, 0, 0);\r\n      // Получаем Base64-код изображения\r\n      const imageBase64 = canvas.toDataURL(\"image/png\");\r\n      // Разрешаем обещание с Base64-кодом\r\n      resolve(imageBase64);\r\n    };\r\n    // Обработчик ошибки загрузки изображения\r\n    img.onerror = function () {\r\n      reject(new Error(\"Ошибка загрузки изображения\"));\r\n    };\r\n    // Устанавливаем URL изображения\r\n    img.crossOrigin = \"anonymous\"; // Разрешаем использование изображений с другого домена\r\n    img.src = imageUrl;\r\n  });\r\n}\r\n\r\nfunction isImage(url) {\r\n  // Простая проверка расширения URL на изображение\r\n  return url.match(/\\.(jpeg|jpg|gif|png|webp)$/i) !== null;\r\n}\r\n\r\nfunction sendToServer(data) {\r\n  const serverEndpoint = \"http://localhost:3000/sendToTelegram\";\r\n\r\n  try {\r\n    // Проверяем, что data - это строка\r\n    if (typeof data !== 'string') {\r\n      throw new Error('Invalid data format. It should be a string.');\r\n    }\r\n\r\n    // Отправляем строку на сервер\r\n    fetch(serverEndpoint, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'text/plain', // Используем text/plain для строки\r\n      },\r\n      body: data,\r\n    })\r\n    .then(response => {\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! Status: ${response.status}`);\r\n      }\r\n      return response.json();\r\n    })\r\n    .then(responseData => {\r\n      if (responseData) {\r\n        console.log('Данные успешно отправлены:', responseData);\r\n      } else {\r\n        console.error('Ответ сервера не содержит данных:', responseData);\r\n      }\r\n    })\r\n    .catch(error => {\r\n      console.error('Ошибка отправки данных на сервер:', error.message);\r\n    });\r\n  } catch (error) {\r\n    console.error('Ошибка форматирования данных:', error.message);\r\n  }\r\n}\r\n\r\nfunction saveNewItem(item) {\r\n  // Add your logic to save the item to your list using chrome.storage.local\r\n  // Modify this function according to your storage requirements\r\n\r\n  sendToServer(item.itemData);\r\n\r\n  console.log(\"Saving new item:\", item);\r\n  chrome.storage.local.get(\"yourItemList\", function (data) {\r\n    const storedList = data.yourItemList || [];\r\n    storedList.push(item);\r\n\r\n    chrome.storage.local.set({ yourItemList: storedList }, function () {\r\n      console.log(\"Item saved successfully:\", item);\r\n    });\r\n  });\r\n}\r\n\r\n// function saveNewItemWithImage(item, imageUrl) {\r\n//   // ... ваш текущий код сохранения ...\r\n\r\n//   // Форматируем изображение и отправляем данные на сервер\r\n//   formatImageAsText(imageUrl)\r\n//     .then((imageBase64) => sendToServer(null, imageBase64))\r\n//     .catch((error) => console.error(\"Error formatting image:\", error));\r\n// }\r\n"],"names":[],"sourceRoot":""}